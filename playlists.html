<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Playlists</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <!-- TOP NAV -->
  <div class="top-nav">
    <button class="nav-button" onclick="location.href='index.html'">&larr; Home</button>
    <button class="nav-button" onclick="location.href='download.html'">Upload Songs</button>
  </div>

  <header>
    <h1>Your Playlists</h1>
    <p>Create playlists from your uploaded songs</p>
  </header>

  <section class="upload-section">

    <!-- CREATE PLAYLIST -->
    <div>
      <h2>Create a Playlist</h2>
      <input type="text" id="playlistNameInput" placeholder="Enter playlist name">
      <button id="createPlaylistBtn" class="nav-button">Create Playlist</button>
    </div>

    <!-- ADD SONG TO PLAYLIST -->
    <div style="margin-top: 20px;">
      <h2>Add Song to Playlist</h2>
      <input type="text" id="songSearchInput" placeholder="Type song name">
      <select id="playlistSelect">
        <option value="">Select a playlist</option>
      </select>
      <button id="addSongBtn" class="nav-button">Add Song</button>
    </div>

    <!-- PLAYLIST DISPLAY -->
    <div id="playlistsContainer" style="margin-top: 30px;">
      <!-- Playlists will appear here -->
    </div>

  </section>

  <!-- AUDIO PLAYER -->
  <div class="audio-player-container">
    <h2>Now Playing</h2>
    <audio id="audioPlayer" controls></audio>
  </div>

  <script>
    // Grab DOM elements
    const playlistNameInput = document.getElementById("playlistNameInput");
    const createPlaylistBtn = document.getElementById("createPlaylistBtn");
    const songSearchInput = document.getElementById("songSearchInput");
    const addSongBtn = document.getElementById("addSongBtn");
    const playlistSelect = document.getElementById("playlistSelect");
    const playlistsContainer = document.getElementById("playlistsContainer");
    const audioPlayer = document.getElementById("audioPlayer");

    // Store playlists in memory (no persistence after reload)
    let playlists = {};

    // Load uploaded songs from download page (sessionStorage)
    let uploadedSongs = sessionStorage.getItem("uploadedSongs");
    if (uploadedSongs) {
      uploadedSongs = JSON.parse(uploadedSongs); // array of {name, dataURL}
    } else {
      uploadedSongs = [];
    }

    // Create playlist
    createPlaylistBtn.addEventListener("click", () => {
      const name = playlistNameInput.value.trim();
      if (!name) {
        alert("Please enter a playlist name.");
        return;
      }
      if (playlists[name]) {
        alert("Playlist already exists.");
        return;
      }
      playlists[name] = [];
      updatePlaylistSelect();
      renderPlaylists();
      playlistNameInput.value = "";
    });

    // Add song to playlist
    addSongBtn.addEventListener("click", () => {
      const playlistName = playlistSelect.value;
      const searchName = songSearchInput.value.trim().toLowerCase();
      if (!playlistName) {
        alert("Please select a playlist.");
        return;
      }
      if (!searchName) {
        alert("Please type a song name.");
        return;
      }

      // Find song by name (case-insensitive, substring match)
      const song = uploadedSongs.find(s => s.name.toLowerCase().includes(searchName));
      if (!song) {
        alert("Song not found in uploaded songs.");
        return;
      }

      playlists[playlistName].push(song);
      renderPlaylists();
      songSearchInput.value = "";
    });

    function updatePlaylistSelect() {
      playlistSelect.innerHTML = "<option value=''>Select a playlist</option>";
      Object.keys(playlists).forEach(name => {
        const option = document.createElement("option");
        option.value = name;
        option.textContent = name;
        playlistSelect.appendChild(option);
      });
    }

    function renderPlaylists() {
      playlistsContainer.innerHTML = "";
      Object.keys(playlists).forEach(name => {
        const playlistDiv = document.createElement("div");
        playlistDiv.style.marginBottom = "20px";

        const title = document.createElement("h3");
        title.textContent = name;
        playlistDiv.appendChild(title);

        const ul = document.createElement("ul");
        playlists[name].forEach(song => {
          const li = document.createElement("li");
          li.textContent = song.name;
          li.style.cursor = "pointer";
          li.addEventListener("click", () => {
            audioPlayer.src = song.dataURL;
            audioPlayer.play();
          });
          ul.appendChild(li);
        });
        playlistDiv.appendChild(ul);
        playlistsContainer.appendChild(playlistDiv);
      });
    }

    // Prepare uploadedSongs in sessionStorage for playlist page
    // This code should also be in download page after adding songs
    if (!sessionStorage.getItem("uploadedSongs")) {
      const songListItems = document.querySelectorAll("#songList li");
      const songsArray = Array.from(songListItems).map(li => ({
        name: li.textContent,
        dataURL: null
      }));
      sessionStorage.setItem("uploadedSongs", JSON.stringify(songsArray));
    }
  </script>

</body>
</html>
